#!/bin/bash

# Definición de funciones y variables de colores
red() { echo -e "\\033[32;1m${*}\\033[0m"; }
red='\033[0;31m'
green='\033[0;32m'
yellow='\033[0;33m'
plain='\033[0m'
blue='\033[0;34m'
ungu='\033[0;35m'
Green="\033[32m"
Red="\033[31m"
WhiteB="\e[5;37m"
BlueCyan="\e[5;36m"
MYIP=$(wget -qO- ipv4.icanhazip.com)
Green_background="\033[42;37m"
Red_background="\033[41;37m"
Suffix="\033[0m"
NC=''
timenow=$(date +%T)

# Función para convertir bytes
function convert() {
    local -i bytes=$1
    if [[ $bytes -lt 1024 ]]; then
        echo "${bytes} B"
    elif [[ $bytes -lt 1048576 ]]; then
        echo "$(((bytes + 1023) / 1024)) KB"
    elif [[ $bytes -lt 1073741824 ]]; then
        echo "$(((bytes + 1048575) / 1048576)) MB"
    else
        echo "$(((bytes + 1073741823) / 1073741824)) GB"
    fi
}

# Función para convertir tiempo a segundos
tim2sec() {
    mult=1
    arg="$1"
    res=0
    while [ ${#arg} -gt 0 ]; do
        prev="${arg%:*}"
        if [ "$prev" = "$arg" ]; then
            curr="${arg#0}"
            prev=""
        else
            curr="${arg##*:}"
            curr="${curr#0}"
        fi
        curr="${curr%%.*}"
        res=$((res + curr * mult))
        mult=$((mult * 60))
        arg="$prev"
    done
    echo "$res"
}

# Encabezado
echo -e "**◇━━━━━━━━━━━━━━━━━◇**"

# Obtener usuarios VMESS
users=($(cat /etc/xray/config.json | grep '^#vmg' | cut -d ' ' -f 2 | sort | uniq))

# Procesar logs
for user in ${users[@]}; do
    logFile=$(cat /var/log/xray/access.log | grep -w "email: ${user}" | tail -n 150)
    usage_bytes=0
    while read -r logline; do
        if [[ -n ${logline} ]]; then
            set -- ${logline}
            # Asumiendo que el tamaño de los datos está en la columna 10
            data_size="${10}"
            usage_bytes=$((usage_bytes + data_size))
        fi
    done <<<"${logFile}"

    if [[ ${usage_bytes} -gt 0 ]]; then
        usage_human=$(convert ${usage_bytes})
        limit_bytes=$(cat /etc/limit/vmess/${user} 2>/dev/null || echo 0)
        limit_human=$(convert ${limit_bytes})
        echo -e "**Account   :** $user"
        echo -e "**Usage     :** ${usage_human}"
        echo -e "**Limit     :** ${limit_human}"
        echo -e "**◇━━━━━━━━━━━━━━━━━◇**"
    fi
done
echo ""
