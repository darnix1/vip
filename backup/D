#!/bin/bash
# check-connections.sh: Muestra usuarios conectados para VMess, VLESS, Trojan
# Compatible con xraylimit.sh mejorado
# Autor: Adaptado para mostrar conexiones activas

# --- Configuración inicial ---
colornow=$(cat /etc/rmbl/theme/color.conf 2>/dev/null || echo "default")
NC="\e[0m"
RED="\033[0;31m"
COLOR1="$(cat /etc/rmbl/theme/$colornow 2>/dev/null | grep -w "TEXT" | cut -d: -f2 | sed 's/ //g' || echo "\e[0m")"
COLBG1="$(cat /etc/rmbl/theme/$colornow 2>/dev/null | grep -w "BG" | cut -d: -f2 | sed 's/ //g' || echo "\e[0m")"
WH='\033[1;37m'
timenow=$(date +%s)

# --- Conversión de bytes (mejorada) ---
convert() {
    local -i bytes=$1
    local suffixes=("B" "KB" "MB" "GB" "TB" "PB")
    local i=0
    local d=0
    while (( bytes >= 1024 && i < ${#suffixes[@]}-1 )); do
        d=$(( (bytes % 1024) * 10 / 1024 ))
        bytes=$(( bytes / 1024 ))
        ((i++))
    done
    if (( d > 0 && i > 0 )); then
        echo "${bytes}.${d} ${suffixes[i]}"
    else
        echo "${bytes} ${suffixes[i]}"
    fi
}

# --- Validación de archivos ---
check_files() {
    local files=("/etc/xray/config.json" "/var/log/xray/access.log")
    for file in "${files[@]}"; do
        [[ ! -f "$file" ]] && { echo "Error: $file no existe"; exit 1; }
    done
}

# --- Reiniciar Xray si es necesario ---
check_xray_log() {
    local xray_lines=$(wc -l < /var/log/xray/access.log)
    if [[ $xray_lines -le 5 ]]; then
        systemctl restart xray >/dev/null 2>&1
        echo "Xray reiniciado: log tenía $xray_lines líneas"
    fi
}

# --- Procesar conexiones por protocolo ---
process_connections() {
    local proto=$1 prefix=$2 dir=$3
    local tmp_file="/tmp/check-$proto" log_file="/var/log/xray/access.log"
    local users log_data ip time ip_count

    # Crear directorio si no existe
    mkdir -p "/etc/limit/$dir" "/etc/$dir" 2>/dev/null

    # Obtener usuarios
    users=($(grep "^#$prefix" /etc/xray/config.json | awk '{print $2}' | sort -u))
    [[ ${#users[@]} -eq 0 ]] && { echo "No se encontraron usuarios para $proto"; return; }

    # Procesar logs con awk
    echo -n > "$tmp_file"
    for user in "${users[@]}"; do
        log_data=$(awk -v user="$user" -v now="$timenow" '
            $0 ~ "email: " user && $3 ~ /tcp:/ {
                split($2, t, ":"); time=mktime(gensub(/[-:]/, " ", "g", $1));
                if (now - time < 40) {
                    ip=gensub(/.*tcp:\/\/([0-9.]+).*/, "\\1", 1, $3);
                    print user, t[1]":"t[2]":"t[3], ip
                }
            }' "$log_file")
        while read -r u t ip; do
            grep -w "$u $t $ip" "$tmp_file" >/dev/null || echo "$u $t WIB : $ip" >> "$tmp_file"
        done <<< "$log_data"
    done

    # Mostrar usuarios conectados
    echo -e "$COLOR1┌─────────────────────────────────────────────────┐${NC}"
    echo -e "$COLOR1│${NC}${COLBG1}             ${WH}• ${proto^^} USER ONLINE •              ${NC}$COLOR1│ $NC"
    echo -e "$COLOR1└─────────────────────────────────────────────────┘${NC}"
    echo -e "$COLOR1┌─────────────────────────────────────────────────┐${NC}"
    for user in "${users[@]}"; do
        ip_count=$(grep -w "$user" "$tmp_file" | wc -l)
        if [[ $ip_count -gt 0 ]]; then
            byt=$(cat "/etc/limit/$dir/$user" 2>/dev/null || echo "0")
            gb=$(convert "$byt")
            lim=$(cat "/etc/$dir/$user" 2>/dev/null || echo "999999999999")
            lim2=$(convert "$lim")
            echo -e "$COLOR1${NC} USERNAME : \033[0;33m$user"
            echo -e "$COLOR1${NC} IP LOGIN : \033[0;33m$ip_count"
            echo -e "$COLOR1${NC} USAGE    : \033[0;33m$gb"
            echo -e "$COLOR1${NC} LIMIT    : \033[0;33m$lim2"
            echo -e ""
        fi
    done
    echo -e "$COLOR1└─────────────────────────────────────────────────┘${NC}"
    echo ""
}

# --- Menú principal ---
main() {
    check_files
    check_xray_log
    clear
    echo "Selecciona un protocolo para verificar conexiones:"
    echo "1. VMess"
    echo "2. VLESS"
    echo "3. Trojan"
    echo "4. Todos"
    echo "5. Salir"
    read -p "Opción [1-5]: " choice

    case $choice in
        1)
            process_connections "vmess" "vmg" "vmess"
            ;;
        2)
            process_connections "vless" "vlg" "vless"
            ;;
        3)
            process_connections "trojan" "trg" "trojan"
            ;;
        4)
            process_connections "vmess" "vmg" "vmess"
            process_connections "vless" "vlg" "vless"
            process_connections "trojan" "trg" "trojan"
            ;;
        5)
            exit 0
            ;;
        *)
            echo "Opción inválida"
            exit 1
            ;;
    esac
    read -n 1 -s -r -p "Presiona cualquier tecla para continuar..."
}

main
